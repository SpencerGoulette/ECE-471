# RpiTank
Project for ECE471

![alt text](https://github.com/SpencerGoulette/ECE-471/blob/master/Final%20Project/Tank.jpg)

# Report
  Our ECE471 project was a remotely controlled tank with an onboard weather station and a Memes on Demand button(trademark pending). This was accomplished with a Raspberry Pi, SPI displays, and stepper motors. The Raspberry Pi ran a web server that had a joystick and live camera feed. The weather was requested using open weather map’s API. The data was then put into an image and displayed on one of the SPI displays. Another notable feature of our tank was the inclusion of a Memes on Demand Button(trademark pending). This button would display memes on the second SPI display. On startup, the second SPI display will show the IP address for the Raspberry Pi so that the user can connect to the webpage.

The Hardware used in this project consisted of two Adafruit TFT 1.44” ST7735R displays [1], two Nema 17 stepper motors [2], two ELEGOO driver module A988s [3], a Adafruit 4-digit 7-segment I2C HT16K33 display [4], a DS18B20 1-wire temperature sensor [5], and a Raspberry Pi model 3B [6]. The communication for the Adafruit SPI displays was done using modified libraries provided by Adafruit. The original library is designed for their larger displays so the buffer size needed to be changed. All pins were connected on the displays except for the 3.3V output pin, the card chip select pin, and the pwm brightness control pin. The sd card was not used for this project so the card select pin was not needed. The backlight defaults to full brightness so changing it was not needed or desired. The Vin was 3.3V and the ground was grounded using the Raspberry Pi. The clock, MISO, and MOSI were wired to the standard Raspberry Pi SPI pins. The first SPI display’s chip select was connected to GPIO8 and the second display’s chip select was connected to GPIO7. The reset pin was wired to GPIO25 and the DC pin was wired to GPIO24, these pins were chosen as they are close to the SPI bus pins. The first display for the weather was running at 80MHz, while the second display for the Memes on Demand Button(trademark pending) was running at 69MHz. The Memes on Demand Button(trademark pending) is using GPIO23. The code for the Memes on Demand Button(trademark pending) is written in Python using hardware interrupts so that it uses less CPU time. The I2C 7 segment display was connected to the Raspberry Pi using the standard I2C pins. The NEMA 17 motors were driven using the ELEGOO Driver Module A988. Since there were two NEMA 17 motors being used, two A988 ELEGOO Driver Modules were used. The ELEGOO Driver Modules took in 3.3V for logic input and GND. GPIO6 was used for the step input for the motor driver of the left motor. The step input driver required a pulse to get the stepper motor to take one step. GPIO19 was used for the step input for the motor driver of the right motor. The GPIOs used for stepping were bit-banged to get it to send the pulses. Another valid way of doing this would have been to use PWM, but bit-banging was used because the code had already been written in a previous homework. GPIO13 was used for the direction input for the motor driver of the left motor. When the direction input of the motor driver is high, the motor turns in the clockwise direction. When the direction input of the motor driver is low, the motor turns in the counterclockwise direction. GPIO26 was used for the direction input for the motor driver of the right motor. To run the motors, the motor drivers also required a power supply between 8V and 35V. As an added bonus, two red LEDs were attached to the back of the tank as backup lights and two yellow LEDs were attached to the front of the tank as headlights. The LEDs were in series with a 1k Ohm resistor.
  
The power for this device was the Raspberry Pi’s 3.3V. Ioctl was used for communicating with the display. All coding for the I2C display was done in C. Power consumption is not a problem for the tank. The Raspberry Pi runs off a 20000mAh battery, and when tested the Pi ran for over 1 day. The stepper motors were powered with a 8.4V NIMH 1600mAh battery. The NIMH battery duration was not tested as it does not have enough power to drive the tank. Testing will be done with the new DC motgors.

The programming languages used were C, Python, JavaScript, and HTML. C was used to run the motors as this would be faster than Python, giving us less delay. Assembly could have been used to further decrease this delay. Python was used to run the LCD displays because Python has great libraries to make implementation easier. Python was also used to get data from the database and then call the C program to run the motors. This was done as Python is good for getting data from websites and parsing it, while the C program was used to decrease the delay time. JavaScript was used to code the joystick on the website, and HTML was used to format the website. Google Firebase was used as the database to hold the coordinates of the joystick. Code density is not an issue as the Raspberry Pi has a 64GB SD card. The Raspberry Pi with all of the programs for the tank running, was at a 75% load. The tank has a soft real time deadline for getting data from Google Firebase, and then running motors. If the system misses the deadline then the tank responds slowly to user input, but no one is harmed and no damage is done to the tank. Another real time constraint is the camera feed. The camera feed is a firm real time deadline as late frames are useless. The Python script takes about half a second to get values from the Google Firebase. Forking was used so the motors could be run while getting the next set of coordinates from the database. If it took longer to get the data than normal, the motors would stop not long after it got the last piece of data. There are some security issues with our project as it has a webpage that is easily accessible, especially on tempest, with a webcam feed on it. A login page should be used to keep unwanted guests from using our tank. Also, it has the database info located in the HTML code so someone can take that, then upload data to it and get data from it. The project utilized a few online sources. The HTML and JavaScript for the webpage was found on github and a part of it was modified for the project. 

The project was rather unique since it was a tank, weather station, and meme station, so it had never been made before. The tank itself had been made before by other people online and is a public 3D model [7]. This project is rather complex to other projects in the class because this project had a lot of parts to it, such as the website, 3D printed tank, weather station, meme station, lights, and motors.

The project was done with a group of three. Jason Millette was in charge of having the Adafruit TFT displays display the IP address of the Raspberry Pi on boot up so that once it was turned on, the Raspberry Pi could easily be SSH’d into. He was also responsible for displaying the weather on an Adafruit SPI display. As an added bonus, he got the displays to be able to display memes of our choosing and it would rotate through the memes by a press of a button. Jason 3D printed the pieces of the Raspberry Pi tank, which he obtained from thingiverse [7], with the 3D printers at the 3D printing club. The total print time was about 100 hours with over 2kg of filament used. Steven Ferrarese was in charge of getting the site up and running and having it display the Joystick, X and Y coordinates, and the Pi camera. He used Google’s Firebase to store the X and Y coordinates. The Pi would have the coordinates from the website be stored on the Firebase and then it would grab them with Python to be used in the motor control C file. Spencer Goulette was in charge of getting the motors rotating at the correct speeds based off of the X and Y coordinates from Google Firebase. Using an algorithm, Spencer was able to convert the X and Y coordinates to motor speeds based on the four quadrants. Spencer was also the one who found the JavaScript code online for the Joystick [8]. As another added bonus, he added headlights and backup lights to the tank so that when the tank goes forward, the headlights turn on and when the tank goes backwards, the backup lights turn on. Everyone took part in putting together the 3D printed pieces. Jason used an angle grinder to cut threaded rod so that they could be threaded through the 3D printed tracks. Steven used epoxy to get the body pieces of the tank to stay together. Spencer attempted to help with threading the tracks and using the epoxy, but he was not that great at it.

The group encountered some challenges while completing the project. After finishing the motor controller script and changing the delay around, it was determined that the motors did not have enough torque to spin the treads. When trying to get the webcam to display on the website, most online support did not work and a python library flask had to be used to host the website and have the webcam display on the website. There was a challenge when trying to get the coordinate values from the website to the motor controller. Normally you can execute commands from javascript but there was permission issues getting this to work, so google database was implemented. Using Open Weather Maps was a challenge. Only some cities are supported, so Old Town and Orono could not be chosen. Parsing the data was also tricky with little experience using json data. Using the SPI displays was a challenge as the Adafruit library was not for the exact display used. The library had to be altered and the documentation and comments were not very good. When the x and y coordinates were obtained from the website, they had to be converted to motor speeds for each motor. The math for this is not too simple and it was quickly realized that deriving the equations would take a while, so it was looked up. The original math obtained was not exactly correct, but gave a good starting point. The original math being wrong was realized when the motors were not going the same speed when going forward. The rest of the math was derived through testing and analysis. The motor control code was still not the best. When both the x and y coordinates were the same, one of the motors would stop working after just a few seconds. The reason for this issue was not realized, so instead an if statement was put in place to have the motors not run if the x and y coordinates were the same. This temporary fix worked well and the chances of someone having the same x and y coordinates on the website was unlikely. One of the biggest challenges faced was getting the wheels of the tank to turn. At first, the shaft of the motors was too small to even get the wheel to turn. So, a part was designed in SolidWorks and printed using one of the Prusa i3 MK2s in the 3D printing lab to fit the shaft that would allow the wheel to turn. When the part was fitted to the shaft of the wheel, it fit well, but the motor still could not turn the wheel. Many tests were done to get the speed of the motor faster. The motor was even run at the max speed and it still was not able to turn the wheel. The group realized at this point that using a stepper motor may not have been the best idea. 

In the future, we would like to have the actual tank be able to move since the stepper motors were unable to turn the wheels of the tank. The plan is to get DC motors that way we easily have enough torque to get the tank to move. A large portion of the Pi’s CPU time is being held up with the camera feed. Optimizing this while decreasing the delay would be a great improvement to the overall performance of the tank. The communication between Google Firebase and the Pi is slow, so we want to get the communication to be faster. We were thinking of probably scrapping Google Firebase and just trying to get it to work using PHP, but we had some permission issues when we tried it this way, so we reverted back to using Google Firebase to have it work for the presentation. We also want all the scripts to run at boot up but we were having some issues with the Pi running all of them at the time, so instead we just have it boot up and run the code that displays the IP address of the Pi as well as the weather program. We then just SSH into the Pi and run the other code. Once we had everything working and organized within the tank, we were planning on adding a top to the tank that we would design on SolidWorks. Our design idea was to make the top have cup holders so that our tank could bring us drinks. There are many other improvements that we could have for the Pi. Having another joystick to somehow rotate the Pi camera would be nice so that you could see your surroundings. If a robotic arm was attached to the tank, we could have it open up small doors and move small obstacles. The robotic arm could also hand deliver us drinks. A peltier device could be implemented to keep our drinks nice and cold during delivery. Plus, Spencer needs someone else to play Ping Pong with, so getting the robot to play Ping Pong with Spencer would be great.


References
[1] Sitronix ”26K Color Single-Chip TFT Controller/Driver”.   [Data sheet]  [Online] Available:https://github.com/JasonMillette/RpiTank/blob/master/datasheets/ST7735R_V0.2.pdf[Accessed:December,2018]

[2] Nema 17 ”42 MM High Torque Hybrid Stepping Motor”.   [Data sheet]  [Online] Available:https://github.com/JasonMillette/RpiTank/blob/master/datasheets/C140-A%2Bdatasheet.jpg[Accessed:December,2018]

[3] ELEGOO ”DMOS Microstepping Driver with Translator and Overcurrent Protection”.   [Data sheet]  [Online] Available:https://github.com/JasonMillette/RpiTank/blob/master/datasheets/A4988%20datasheet.pdf[Accessed:December,2018]

[4] Adafruit  ”Adafruit LED Backpacks”.   [Data sheet]  [Online] Available:https://github.com/JasonMillette/Rpi Tank/blob/master/datasheets/adafruit-led-backpack.pdf[Accessed:December,2018]

[5] Maximum Integrated ”Programmable Resolution 1-Wire Digital Thermometer”.   [Data sheet]  [Online] Available:https://github.com/JasonMillette/RpiTank/blob/master/datasheets/DS18B20.pdf[Accessed:December,2018]

[6] Raspberry Pi Model B3 ”Raspberry Pi Hardware”.   [Data sheet]  [Online] Available:https://www.raspberrypi.org/documentation/hardware/]
 
[7] Drogerdy  ”Raspberry Pi Controlled Tank Bot”.   [Data sheet]  [Online] Available:https://www.thingiverse.com/thing:652851[Accessed:December,2018]

[8] Tienne “Virtual Joystick” [Example][Online] 
Available: http://jeromeetienne.github.io/virtualjoystick.js/examples/basic.html
